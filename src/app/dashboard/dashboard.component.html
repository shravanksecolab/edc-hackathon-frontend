<mat-toolbar color="primary">
    <div class="app-title">
        <mat-icon class="app-logo">shield</mat-icon>
        <div class="title-text">
            <span class="main-title">PestGuard</span>
            <span class="sub-title">Threat Monitor</span>
        </div>
    </div>
    <span class="spacer"></span>
    <!-- Site Selection Dropdown -->
    <div class="site-selection-container">
        <div class="site-dropdown-wrapper">
            <button mat-button class="site-selector-button" [matMenuTriggerFor]="siteMenu"
                [disabled]="userSites.length === 0">
                <mat-icon class="site-icon">location_on</mat-icon>
                <span class="selected-site-name">
                    {{ userSites.length === 0 ? 'No Sites Available' : (selectedSiteId?.site_name || 'Select a Site') }}
                </span>
                <!-- <mat-icon class="dropdown-arrow">keyboard_arrow_down</mat-icon> -->
            </button>

            <mat-menu #siteMenu="matMenu" class="site-menu">
                <!-- Search bar -->
                <div class="site-search-container" (click)="$event.stopPropagation()">
                    <mat-form-field appearance="outline" class="site-search-field">
                        <mat-label>Search sites...</mat-label>
                        <input matInput [(ngModel)]="siteSearchTerm" (input)="filterSites()"
                            placeholder="Type to search sites" autocomplete="off">
                        <mat-icon matSuffix>search</mat-icon>
                    </mat-form-field>
                </div>

                <!-- Filtered site list -->
                <button mat-menu-item *ngFor="let site of filteredSites" (click)="onSiteChange(site)"
                    [class.selected]="selectedSiteId?.site_code === site.site_code">
                    <mat-icon>
                        {{ selectedSiteId?.site_code === site.site_code ? 'check_circle' : 'location_on' }}
                    </mat-icon>
                    <span>{{ site.site_name }}</span>
                </button>

                <!-- No results message -->
                <div class="no-sites-message" *ngIf="filteredSites.length === 0 && siteSearchTerm">
                    <mat-icon>search_off</mat-icon>
                    <span>No sites found matching "{{ siteSearchTerm }}"</span>
                </div>
            </mat-menu>

            <!-- Info Icon with Site Details Popup -->
            <div class="info-icon-container" *ngIf="siteDetails">
                <mat-icon class="info-icon" style="display: flex; align-items: center;">info</mat-icon>

                <!-- Site Details Popup -->
                <div class="site-details-popup">
                    <div class="site-details-header">
                        <mat-icon>location_on</mat-icon>
                        <h3>Site Details</h3>
                    </div>
                    <table class="site-details-table">
                        <tbody>
                            <tr *ngFor="let field of getSiteDetailsFields()">
                                <td class="field-label">{{ field.label }}</td>
                                <td class="field-value">{{ field.value }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <button mat-icon-button class="notifications-button" [matMenuTriggerFor]="notificationsMenu"
        #notificationsTrigger="matMenuTrigger">
        <mat-icon [matBadge]="getUnreadNotificationsCount()" [matBadgeHidden]="getUnreadNotificationsCount() === 0"
            matBadgeColor="warn" matBadgeSize="small">
            notifications
        </mat-icon>
    </button>

    <div class="user-profile-container">
        <button class="user-profile" mat-icon-button [matMenuTriggerFor]="userMenu">
            <div class="user-initials">{{ getUserInitials() }}</div>
        </button>
        <div class="user-name-display">{{ formatName(currentUser || 'User') }}</div>
    </div>

    <mat-menu #userMenu="matMenu">
        <div class="user-info-popup">
            <div class="user-details">
                <mat-icon class="user-avatar">account_circle</mat-icon>
                <div class="user-info">
                    <span class="user-name">{{ currentUser || 'User' }}</span>
                    <span class="user-mail-id">{{ currentUserMailId }}</span>
                    <span class="user-mail-id">(Store Manager)</span>
                </div>
            </div>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="logout()" [disabled]="isLoggingOut">
                <mat-icon *ngIf="!isLoggingOut">logout</mat-icon>
                <mat-icon *ngIf="isLoggingOut" class="spinning">hourglass_empty</mat-icon>
                <span *ngIf="!isLoggingOut">Logout</span>
                <span *ngIf="isLoggingOut">Logging out...</span>
            </button>
        </div>
    </mat-menu>

    <mat-menu #notificationsMenu="matMenu" class="notifications-menu">
        <div class="notifications-header">
            <h4>Notifications</h4>
            <button mat-icon-button class="clear-all-btn" (click)="clearAllNotifications()"
                [disabled]="notifications.length === 0">
                <mat-icon>clear_all</mat-icon>
            </button>
        </div>

        <div class="notifications-list" *ngIf="notifications.length > 0; else noNotifications">
            <div class="notification-item" *ngFor="let notification of notifications"
                [class.unread]="!notification.read" (click)="markAsRead(notification)">
                <div class="notification-icon">
                    <mat-icon [ngClass]="getNotificationIconClass(notification.type)">
                        {{ getNotificationIcon(notification.type) }}
                    </mat-icon>
                </div>
                <div class="notification-content">
                    <div class="notification-title">{{ notification.title }}</div>
                    <div class="notification-message">{{ notification.message }}</div>
                    <div class="notification-time">{{ notification.timestamp | date:'short' }}</div>
                </div>
                <div class="notification-actions" *ngIf="!notification.read">
                    <button mat-icon-button class="mark-read-btn"
                        (click)="markAsRead(notification); $event.stopPropagation()">
                        <mat-icon>done</mat-icon>
                    </button>
                </div>
            </div>
        </div>

        <ng-template #noNotifications>
            <div class="no-notifications">
                <mat-icon>notifications_none</mat-icon>
                <p>No notifications</p>
            </div>
        </ng-template>
    </mat-menu>
</mat-toolbar>
<div class="main-content">
    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoadingUserSites">
        <div class="loader-wrapper">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading dashboard data...</p>
        </div>
    </div>

    <!-- Dashboard Tab Content -->
    <div class="dashboard-content" *ngIf="!isLoadingUserSites">
        <div class="dashboard-grid">

            <!-- Risk Breakdown Card -->
            <mat-card class="dashboard-card risk-breakdown-card">
                <mat-card-header>
                    <mat-card-title>
                        <mat-icon>analytics</mat-icon>
                        Risk Breakdown
                    </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <!-- Loading State for Risk Breakdown -->
                    <div class="content-loading" *ngIf="isLoadingRiskBreakdown">
                        <div class="loading-spinner"></div>
                        <p>Loading risk breakdown data...</p>
                    </div>

                    <div class="risk-breakdown-container" *ngIf="!isLoadingRiskBreakdown">
                        <!-- Overall Risk Score -->
                        <div class="overall-risk-section">
                            <h3 class="section-title">Overall Risk</h3>

                            <!-- Risk Score Value -->
                            <div class="risk-score-display">
                                <span class="score-number"
                                    [ngClass]="overallRiskScore ? getRiskLevelClass(overallRiskScore).toLowerCase() : 'manageable'">{{
                                    overallRiskScore || '0'}}</span>
                            </div>

                            <!-- Progress Bar -->
                            <div class="progress-container">
                                <mat-progress-bar mode="determinate" [value]="overallRiskScore"
                                    [ngClass]="getProgressBarClass(overallRiskScore)">
                                </mat-progress-bar>
                            </div>

                            <!-- Risk Level Indicator -->
                            <div class="risk-level-indicator">
                                <span class="risk-status"
                                    [ngClass]="overallRiskScore ? getRiskLevelClass(overallRiskScore).toLowerCase() : 'manageable'">
                                    {{ overallRiskScore ? getRiskLevelClass(overallRiskScore) : 'Manageable'}}
                                </span>
                            </div>
                        </div>

                        <!-- Risk Breakdown Scores -->
                        <div class="risk-scores-section">
                            <!-- External Risk Breakdown -->
                            <div class="score-category">
                                <div class="score-category-header">
                                    <div class="score-label">
                                        <mat-icon>public</mat-icon>
                                        External Risk
                                    </div>
                                    <div class="score-value"
                                        [ngClass]="externalRiskScore ? getRiskLevelClass(externalRiskScore).toLowerCase() : 'manageable'">
                                        {{ externalRiskScore || '0'}}
                                    </div>
                                </div>
                                <!-- Loading state when no external risk factors are available -->
                                <div class="breakdown-item" *ngIf="externalRiskFactors.length === 0">
                                    <span class="breakdown-label">
                                        No external risk factors found
                                    </span>
                                    <span class="breakdown-value"></span>
                                </div>
                                <div class="score-breakdown">
                                    <div class="breakdown-item" *ngFor="let factor of externalRiskFactors">
                                        <span class="breakdown-label">
                                            {{ factor.riskCategory }}
                                        </span>
                                        <span class="breakdown-value">{{ factor.score }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Internal Risk Breakdown -->
                            <div class="score-category">
                                <div class="score-category-header">
                                    <div class="score-label">
                                        <mat-icon>business</mat-icon>
                                        Internal Risk
                                    </div>
                                    <div class="score-value"
                                        [ngClass]="internalRiskScore != 0.0 ? getRiskLevelClass(internalRiskScore).toLowerCase() : 'grey-out'">
                                        {{ internalRiskScore || '0'}}
                                    </div>
                                </div>

                                <!-- Loading state when no internal risk factors are available -->
                                <div class="breakdown-item" *ngIf="internalRiskFactors.length === 0">
                                    <span class="breakdown-label">
                                        Reach out to ECOLAB to get started
                                    </span>
                                    <span class="breakdown-value"></span>
                                </div>
                                <div class="score-breakdown">
                                    <div class="breakdown-item" *ngFor="let factor of internalRiskFactors">
                                        <span class="breakdown-label">
                                            {{ factor.riskCategory }}
                                        </span>
                                        <span class="breakdown-value">{{ factor.score }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <!-- Contributing Factors Card -->
            <mat-card class="dashboard-card contributing-factors-card">
                <mat-card-header>
                    <mat-card-title>
                        <mat-icon>psychology</mat-icon>
                        Contributing Factors
                    </mat-card-title>
                    <mat-card-subtitle>Key factors influencing current threat level</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <!-- Contributing Factors Toggle -->
                    <div class="contributing-factors-toggle-container" *ngIf="!isLoadingContributingFactors">
                        <mat-button-toggle-group [(ngModel)]="selectedContributingFactorsView"
                            class="contributing-factors-toggle" (change)="onContributingFactorsToggle($event)">
                            <mat-button-toggle value="external">
                                <mat-icon>public</mat-icon>
                                External Factors
                            </mat-button-toggle>
                            <mat-button-toggle value="internal">
                                <mat-icon>business</mat-icon>
                                Internal Factors
                            </mat-button-toggle>
                        </mat-button-toggle-group>
                    </div>

                    <!-- Loading State for Contributing Factors -->
                    <div class="content-loading" *ngIf="isLoadingContributingFactors">
                        <div class="loading-spinner"></div>
                        <p>Loading contributing factors...</p>
                    </div>

                    <div class="factors-container" *ngIf="!isLoadingContributingFactors">
                        <div class="factor-item" *ngFor="let factor of contributingFactors">
                            <div class="factor-header">
                                <div class="factor-name-with-icon">
                                    <!-- <mat-icon [ngStyle]="{'color': factor.color}">{{ factor.icon }}</mat-icon> -->
                                    <span class="factor-name">{{ factor.reason
                                        }}</span>
                                </div>
                                <span class="factor-percentage" [ngStyle]="{'color': factor.color}">{{ factor.percent
                                    }}%</span>
                            </div>
                            <div class="factor-progress">
                                <mat-progress-bar mode="determinate" [value]="factor.percent"
                                    [ngStyle]="{'--progress-color': factor.color}">
                                </mat-progress-bar>
                            </div>
                            <div>
                                {{factor.subtext}}
                            </div>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <!-- Toggle for External/Internal View -->
            <div class="view-toggle-container">
                <mat-button-toggle-group [(ngModel)]="selectedView" class="view-toggle" (change)="onViewToggle($event)">
                    <mat-button-toggle value="external">External</mat-button-toggle>
                    <mat-button-toggle value="internal">Internal</mat-button-toggle>
                </mat-button-toggle-group>

                <div class="action-buttons">
                    <button mat-stroked-button color="primary" class="action-btn call-ecolab-btn">
                        <mat-icon>phone</mat-icon>
                        Call ECOLAB
                    </button>
                    <button mat-raised-button color="accent" class="action-btn request-service-btn">
                        <mat-icon>build</mat-icon>
                        Request Service
                    </button>
                </div>
            </div>

            <!-- Dynamic Content based on toggle selection -->
            <div class="dynamic-content" [ngSwitch]="selectedView">

                <!-- External View Content -->
                <div *ngSwitchCase="'external'" class="content-section">
                    <mat-card class="dashboard-card">
                        <mat-card-header>
                            <mat-card-title>
                                <mat-icon>public</mat-icon>
                                My External Insights
                            </mat-card-title>
                        </mat-card-header>
                        <mat-card-content>
                            <!-- <p>Monitor external risks affecting your organization.</p> -->
                            <div class="stat-cards-container">
                                <mat-card class="stat-card expandable-card" *ngFor="let card of externalStatCards">
                                    <div class="card-header-section">
                                        <div class="stat-info">
                                            <div class="stat-label">{{ card.label }}</div>
                                            <!-- <div class="stat-value" [ngClass]="getStatValueClasses(card)"
                                                [matTooltip]="card.locked ? 'Premium content - Upgrade to unlock detailed insights' : null">
                                                {{ card.value }}
                                            </div> -->
                                        </div>
                                        <div matTooltipPosition="above" class="tooltip-wrapper">
                                            <button mat-icon-button class="expand-button" [class.locked]="card.locked"
                                                (click)="card.locked ? null : toggleExternalCard(card)"
                                                [attr.aria-label]="card.locked ? 'Premium Content' : (card.expanded ? 'Collapse' : 'Expand')"
                                                [disabled]="card.locked">
                                                <mat-icon *ngIf="!card.locked">{{ card.expanded ? 'expand_less' :
                                                    'expand_more'
                                                    }}</mat-icon>
                                                <mat-icon *ngIf="card.locked" class="red-icon">lock</mat-icon>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Expandable Content -->
                                    <div class="expandable-content" *ngIf="card.expanded">
                                        <div class="content-section">
                                            <!-- <p class="content-description">{{ card.content.description }}</p> -->

                                            <!-- Day Toggle -->
                                            <div class="day-toggle-container" *ngIf="card.hasToggle && showDaysToggle">
                                                <mat-button-toggle-group size="small" [(ngModel)]="card.selectedDays"
                                                    class="day-toggle" (change)="onDayToggleChange(card, $event)">
                                                    <mat-button-toggle value="7">7 Days</mat-button-toggle>
                                                    <mat-button-toggle value="30">30 Days</mat-button-toggle>
                                                </mat-button-toggle-group>
                                            </div>

                                            <div class="content-details">
                                                <!-- Loading State -->
                                                <div class="content-loading" *ngIf="card.isLoadingContent">
                                                    <div class="loading-spinner"></div>
                                                </div>

                                                <!-- Content Display -->
                                                <div *ngIf="!card.isLoadingContent">
                                                    <h5>Summary</h5>
                                                    <div class="summary-text"
                                                        [innerHTML]="markdownToHtml(card.content || 'No Data Found')"
                                                        *ngIf="card.content">
                                                    </div>
                                                    <p *ngIf="!card.content">No Data Found</p>
                                                </div>

                                                <!-- Content Display -->
                                                <div class="mt-2"
                                                    *ngIf="card.hasNews && card.news && !card.isLoadingHdiNews">
                                                    <h5>HDI News</h5>
                                                    <div class="summary-text"
                                                        [innerHTML]="markdownToHtml(card.news || 'No Data Found')"
                                                        *ngIf="card.news">
                                                    </div>
                                                    <p *ngIf="!card.news">No Data Found</p>
                                                </div>
                                            </div>

                                            <!-- <div class="content-recommendations">
                                                <h5>Recommendations:</h5>
                                                <p>{{ card.content.recommendations }}</p>
                                            </div> -->
                                        </div>
                                    </div>
                                </mat-card>
                            </div>
                        </mat-card-content>
                        <!-- <mat-card-actions>
                        <button mat-button color="primary">View External Report</button>
                    </mat-card-actions> -->
                    </mat-card>
                </div>

                <!-- Internal View Content -->
                <div *ngSwitchCase="'internal'" class="content-section">
                    <!-- Month on Month Chart -->
                    <mat-card class="analytics-card month-on-month-card">
                        <mat-card-header>
                            <mat-card-title>
                                <mat-icon>trending_up</mat-icon>
                                Month-on-Month Site Analysis
                            </mat-card-title>
                            <mat-card-subtitle>Tracking pest causing trends across different categories</mat-card-subtitle>
                        </mat-card-header>
                        <mat-card-content>
                            <!-- Loading State -->
                            <div class="chart-loading" *ngIf="isLoadingMonthOnMonth">
                                <div class="loading-spinner"></div>
                                <p>Loading chart data...</p>
                            </div>

                            <!-- Chart Container -->
                            <div class="chart-container" *ngIf="!isLoadingMonthOnMonth && monthOnMonthData.length > 0">
                                <!-- Combined Time Filter and Legend Row -->
                                <div class="filter-legend-row">
                                    <!-- Time Filter Buttons -->
                                    <div class="time-filter-container">
                                        <div class="filter-label">Time Range:</div>
                                        <mat-button-toggle-group [(ngModel)]="selectedTimeFilter"
                                            class="time-filter-toggles" (change)="onTimeFilterChange($event.value)">
                                            <mat-button-toggle *ngFor="let option of timeFilterOptions"
                                                [value]="option.value">
                                                {{ option.label }}
                                            </mat-button-toggle>
                                        </mat-button-toggle-group>
                                    </div>

                                    <!-- Chart Legend -->
                                    <div class="chart-legend">
                                        <div class="legend-item" *ngFor="let dataset of chartDatasets"
                                            (click)="toggleDatasetVisibility(dataset)"
                                            [class.legend-hidden]="!dataset.visible"
                                            [attr.title]="dataset.visible ? 'Click to hide ' + dataset.label : 'Click to show ' + dataset.label">
                                            <div class="legend-color"
                                                [style.background-color]="dataset.backgroundColor">
                                            </div>
                                            <span class="legend-label">{{ dataset.label }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Scroll hint -->
                                <div class="scroll-hint" *ngIf="chartLabels.length > 6">
                                    <mat-icon>swipe</mat-icon>
                                    <span>Scroll horizontally to view all months</span>
                                </div>

                                <div class="custom-chart">
                                    <div class="chart-y-axis">
                                        <div class="y-axis-label" *ngFor="let tick of getYAxisTicks()">{{ tick }}</div>
                                    </div>

                                    <div class="chart-plot-area">
                                        <!-- SVG Line Chart -->
                                        <svg class="line-chart-svg" [attr.width]="chartLabels.length * 100"
                                            height="300">
                                            <!-- Grid lines -->
                                            <g class="grid-lines">
                                                <line *ngFor="let tick of getYAxisTicks(); let i = index" x1="0"
                                                    [attr.y1]="i * (300 / (getYAxisTicks().length - 1))"
                                                    [attr.x2]="chartLabels.length * 100"
                                                    [attr.y2]="i * (300 / (getYAxisTicks().length - 1))"
                                                    stroke="#e0e0e0" stroke-width="0.5" opacity="0.5">
                                                </line>
                                            </g>

                                            <!-- Lines for each dataset -->
                                            <g *ngFor="let dataset of chartDatasets; let datasetIndex = index"
                                                class="line-group" [style.display]="dataset.visible ? 'block' : 'none'">
                                                <polyline [attr.points]="getLinePoints(dataset.data)"
                                                    [attr.stroke]="dataset.backgroundColor" stroke-width="3" fill="none"
                                                    stroke-linecap="round" stroke-linejoin="round">
                                                </polyline>

                                                <!-- Data points -->
                                                <circle *ngFor="let value of dataset.data; let i = index"
                                                    [attr.cx]="i * 100 + 50" [attr.cy]="300 - getBarHeight(value) * 3"
                                                    r="4" [attr.fill]="dataset.backgroundColor" stroke="white"
                                                    stroke-width="2" class="data-point"
                                                    [matTooltip]="dataset.label + ': ' + value + ' (' + chartLabels[i] + ')'">
                                                </circle>
                                            </g>
                                        </svg>

                                        <!-- Month labels -->
                                        <div class="month-labels">
                                            <div class="month-label" *ngFor="let label of chartLabels"
                                                [style.left.px]="chartLabels.indexOf(label) * 100 + 50">
                                                {{ label }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- No Data State -->
                            <div class="no-chart-data" *ngIf="!isLoadingMonthOnMonth && monthOnMonthData.length === 0">
                                <mat-icon>bar_chart</mat-icon>
                                <p>No month-on-month data available for the selected site</p>
                            </div>
                        </mat-card-content>
                    </mat-card>

                    <!-- Service History Cards -->
                    <mat-card class="dashboard-card service-history-card">
                        <mat-card-header>
                            <mat-card-title>
                                <mat-icon>history</mat-icon>
                                Service History
                            </mat-card-title>
                            <mat-card-subtitle>Recent service visits and findings</mat-card-subtitle>
                        </mat-card-header>
                        <mat-card-content>
                            <!-- Loading State -->
                            <div class="content-loading" *ngIf="isLoadingServiceData">
                                <div class="loading-spinner"></div>
                                <p>Loading service data...</p>
                            </div>

                            <!-- Service Cards -->
                            <div class="service-cards-container" *ngIf="!isLoadingServiceData">
                                <div class="service-card" *ngFor="let card of serviceCards"
                                    [class.expanded]="card.expanded">

                                    <!-- Collapsed Card View -->
                                    <div class="service-card-header" (click)="toggleServiceCard(card)">
                                        <div class="service-card-main-info">
                                            <div class="service-card-title">
                                                <mat-icon>build</mat-icon>
                                                <span class="visit-type">{{ card.visitType }}</span>
                                            </div>
                                            <div class="service-card-details">
                                                <div class="visit-date">
                                                    <mat-icon>calendar_today</mat-icon>
                                                    <span>{{ card.visitDate }}</span>
                                                </div>
                                                <div class="findings-actions">
                                                    <mat-icon>assignment</mat-icon>
                                                    <span>{{ card.findingActions }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="service-card-toggle">
                                            <mat-icon>{{ card.expanded ? 'expand_less' : 'expand_more' }}</mat-icon>
                                        </div>
                                    </div>

                                    <!-- Expanded Card View -->
                                    <div class="service-card-expanded" *ngIf="card.expanded">
                                        <mat-divider></mat-divider>

                                        <div class="expanded-content">
                                            <!-- Service Counts Section -->
                                            <div class="service-counts-section">
                                                <h4>Service Counts</h4>
                                                <div class="counts-grid">
                                                    <div class="count-item">
                                                        <mat-icon>cleaning_services</mat-icon>
                                                        <span class="count-label">Sanitation</span>
                                                        <span class="count-value">{{ card.sanitationCount }}</span>
                                                    </div>
                                                    <div class="count-item">
                                                        <mat-icon>construction</mat-icon>
                                                        <span class="count-label">Structural</span>
                                                        <span class="count-value">{{ card.structuralCount }}</span>
                                                    </div>
                                                    <div class="count-item">
                                                        <mat-icon>restaurant</mat-icon>
                                                        <span class="count-label">Prep</span>
                                                        <span class="count-value">{{ card.prepCount }}</span>
                                                    </div>
                                                    <div class="count-item">
                                                        <mat-icon>bug_report</mat-icon>
                                                        <span class="count-label">Pest</span>
                                                        <span class="count-value">{{ card.pestCount }}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Findings Section -->
                                            <div class="findings-section">
                                                <h4>Specific Findings</h4>
                                                <div class="findings-grid">
                                                    <div class="finding-item">
                                                        <mat-icon>pets</mat-icon>
                                                        <span class="finding-label">Rodent Findings</span>
                                                        <span class="finding-value"
                                                            [ngClass]="{'high-count': card.rodentFindings > 5, 'medium-count': card.rodentFindings > 0 && card.rodentFindings <= 5, 'zero-count': card.rodentFindings === 0}">
                                                            {{ card.rodentFindings }}
                                                        </span>
                                                    </div>
                                                    <div class="finding-item">
                                                        <mat-icon>emoji_nature</mat-icon>
                                                        <span class="finding-label">Cockroach Findings</span>
                                                        <span class="finding-value"
                                                            [ngClass]="{'high-count': card.cockroachFindings > 5, 'medium-count': card.cockroachFindings > 0 && card.cockroachFindings <= 5, 'zero-count': card.cockroachFindings === 0}">
                                                            {{ card.cockroachFindings }}
                                                        </span>
                                                    </div>
                                                    <div class="finding-item">
                                                        <mat-icon>flutter_dash</mat-icon>
                                                        <span class="finding-label">Large Fly Findings</span>
                                                        <span class="finding-value"
                                                            [ngClass]="{'high-count': card.largeFlyFindings > 5, 'medium-count': card.largeFlyFindings > 0 && card.largeFlyFindings <= 5, 'zero-count': card.largeFlyFindings === 0}">
                                                            {{ card.largeFlyFindings }}
                                                        </span>
                                                    </div>
                                                    <!-- <div class="finding-item">
                                                        <mat-icon>notification_important</mat-icon>
                                                        <span class="finding-label">IoT Alerts</span>
                                                        <span class="finding-value alert-count"
                                                            [ngClass]="{'high-count': card.confirmedAlerts > 0, 'zero-count': card.confirmedAlerts === 0}">
                                                            {{ card.confirmedAlerts }}
                                                        </span>
                                                    </div> -->
                                                </div>
                                            </div>

                                            <!-- Additional Service Details -->
                                            <div class="additional-details-section">
                                                <h4>Service Details</h4>
                                                <div class="details-info">
                                                    <div class="detail-item">
                                                        <mat-icon>wifi</mat-icon>
                                                        <span class="detail-label">IoT Alerts:</span>
                                                        <span class="detail-value">{{ card.confirmedAlerts }}</span>
                                                    </div>
                                                    <div class="detail-item">
                                                        <mat-icon>person</mat-icon>
                                                        <span class="detail-label">Condition Description:</span>
                                                        <span class="detail-value">{{ card.conditionDescription
                                                            }}</span>
                                                    </div>
                                                    <div class="detail-item">
                                                        <mat-icon>check_circle</mat-icon>
                                                        <span class="detail-label">Condition Comments:</span>
                                                        <span class="detail-value status">
                                                            <!-- [ngClass]="{'status-completed': card.conditionComments === 'Completed', 'status-pending': card.conditionComments !== 'Completed'}"> -->
                                                            {{ card.conditionComments }}
                                                        </span>
                                                    </div>
                                                    <div class="detail-item" *ngIf="card.findingActions !== 'N/A'">
                                                        <mat-icon>schedule</mat-icon>
                                                        <span class="detail-label">Finding Actions:</span>
                                                        <span class="detail-value">{{ card.findingActions }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- No Service Data Message -->
                                <div class="no-service-data" *ngIf="serviceCards.length === 0">
                                    <mat-icon>history</mat-icon>
                                    <p>No service history available for this site</p>
                                </div>
                            </div>
                        </mat-card-content>
                    </mat-card>


                    <!-- Internal AI Recommendations Card -->
                    <mat-card class="dashboard-card internal-summary-card">
                        <mat-card-header>
                            <mat-card-title>
                                <mat-icon>psychology</mat-icon>
                                Internal AI Recommendations
                            </mat-card-title>
                            <mat-card-subtitle>AI-powered insights and recommendations</mat-card-subtitle>
                        </mat-card-header>
                        <mat-card-content>
                            <!-- Loading State -->
                            <div class="content-loading" *ngIf="isLoadingInternalAI">
                                <div class="loading-spinner"></div>
                                <p>Loading internal AI recommendations...</p>
                            </div>

                            <!-- Content -->
                            <div class="internal-summary-content mt-4" *ngIf="!isLoadingInternalAI">
                                <div class="summary-text" [innerHTML]="markdownToHtml(internalAISummary)"
                                    *ngIf="internalAISummary && internalAISummary !== 'No internal AI summary available' && internalAISummary !== 'Error loading internal AI summary'">
                                </div>
                                <div class="no-data-message"
                                    *ngIf="!internalAISummary || internalAISummary === 'No internal AI summary available' || internalAISummary === 'Error loading internal AI summary'">
                                    <p>{{ internalAISummary === 'Error loading internal AI summary' ? 'Error loading
                                        internal AI recommendations' : 'No internal AI recommendations available' }}</p>
                                </div>
                            </div>
                        </mat-card-content>
                    </mat-card>

                    <!-- Internal Summary Cards Row -->
                    <div class="internal-summary-cards-row">
                        <!-- Yelp Internal Summary Card -->
                        <mat-card class="dashboard-card internal-summary-card">
                            <mat-card-header>
                                <mat-card-title>
                                    <mat-icon>star</mat-icon>
                                    Yelp Summary
                                </mat-card-title>
                                <mat-card-subtitle>Customer feedback and review analysis</mat-card-subtitle>
                            </mat-card-header>
                            <mat-card-content>
                                <!-- Loading State -->
                                <div class="content-loading" *ngIf="isLoadingYelpInternal">
                                    <div class="loading-spinner"></div>
                                    <p>Loading Yelp internal data...</p>
                                </div>

                                <!-- Content -->
                                <div class="internal-summary-content" *ngIf="!isLoadingYelpInternal">
                                    <div class="summary-text" [innerHTML]="markdownToHtml(yelpInternalSummary)"
                                        *ngIf="yelpInternalSummary">
                                    </div>
                                    <div class="no-data-message" *ngIf="!yelpInternalSummary">
                                        <mat-icon>info</mat-icon>
                                        <p>No Yelp internal summary data available</p>
                                    </div>
                                </div>
                            </mat-card-content>
                        </mat-card>

                        <!-- HDI Internal Summary Card -->
                        <mat-card class="dashboard-card internal-summary-card hdi-locked-card">
                            <div class="custom-card-header">
                                <div class="header-top-row">
                                    <div class="card-title">
                                        <mat-icon>assessment</mat-icon>
                                        <span>HDI Summary</span>
                                    </div>
                                    <mat-icon class="lock-icon"
                                        matTooltip="Premium content - Upgrade to unlock detailed insights">lock</mat-icon>
                                </div>
                                <div class="card-subtitle">Internal health department insights</div>
                            </div>
                            <mat-card-content></mat-card-content>
                        </mat-card>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chatbot -->
<div class="chatbot-container">
    <!-- Overlay for chatbot popup -->
    <div class="chatbot-overlay" [class.open]="chatbotOpen" (click)="toggleChatbot()"></div>

    <!-- Sticky Chatbot Button -->
    <button mat-fab color="primary" class="chatbot-fab" (click)="toggleChatbot()" [class.active]="chatbotOpen">
        <mat-icon>chat</mat-icon>
    </button>

    <!-- Chatbot Popup -->
    <div class="chatbot-popup" [class.open]="chatbotOpen">
        <div class="chatbot-header">
            <div class="chatbot-title">
                <mat-icon>smart_toy</mat-icon>
                <span>EVA</span>
            </div>
            <button mat-icon-button (click)="toggleChatbot()" class="close-btn">
                <mat-icon>close</mat-icon>
            </button>
        </div>

        <div class="chatbot-body">
            <div class="chat-messages">
                <div *ngFor="let message of chatMessages" class="message"
                    [ngClass]="{'user-message': message.isUser, 'bot-message': !message.isUser}">
                    <div class="message-avatar" *ngIf="!message.isUser">
                        <mat-icon>smart_toy</mat-icon>
                    </div>
                    <div class="message-content">
                        <div class="message-text" [ngClass]="{'typing-indicator': message.isTyping}">
                            <!-- For user messages, display as plain text -->
                            <span *ngIf="message.isUser && !message.isTyping">{{ message.text }}</span>

                            <!-- For bot messages, use innerHTML to render HTML from markdown -->
                            <div *ngIf="!message.isUser && !message.isTyping"
                                [innerHTML]="getFormattedBotMessage(message.text)" class="bot-message-content">
                            </div>

                            <!-- Typing indicator -->
                            <div *ngIf="message.isTyping" class="typing-dots">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                        </div>
                        <div class="message-time" *ngIf="!message.isTyping">{{ message.timestamp | date:'short' }}</div>
                    </div>
                    <div class="message-avatar" *ngIf="message.isUser">
                        <mat-icon>account_circle</mat-icon>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions" *ngIf="chatMessages.length <= 1">
                <div class="quick-action-title">Quick Actions:</div>
                <div class="quick-action-buttons">
                    <button mat-stroked-button (click)="currentMessage = 'Explain my risk scores'; sendMessage()">
                        Explain Risk Scores
                    </button>
                    <button mat-stroked-button (click)="currentMessage = 'Show site recommendations'; sendMessage()">
                        Site Recommendations
                    </button>
                    <!-- <button mat-stroked-button (click)="currentMessage = 'Help with security'; sendMessage()">
                        Security Help
                    </button> -->
                </div>
            </div>
        </div>

        <div class="chatbot-footer">
            <mat-form-field appearance="outline" class="message-input">
                <input matInput [(ngModel)]="currentMessage" placeholder="Type your message..."
                    (keyup.enter)="sendMessage()" #messageInput>
            </mat-form-field>
            <button mat-icon-button color="primary" (click)="sendMessage()" [disabled]="!currentMessage.trim()">
                <mat-icon>send</mat-icon>
            </button>
        </div>
    </div>
</div>